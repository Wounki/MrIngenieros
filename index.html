<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti贸n de Contratos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.rawgit.com/cozmo/jsQR/master/dist/jsQR.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const { createClient } = window.supabase;
    </script>
    
</head>
<body>
    <div class="container">
        <div class="login-container" id="login-form">
            <h1>Sistema de Gesti贸n de Contratos</h1>
            <div class="form-group">
                <label for="username">Usuario:</label>
                <input type="text" id="username" name="username">
            </div>
            <div class="form-group">
                <label for="password">Contrase帽a:</label>
                <input type="password" id="password" name="password">
            </div>
            <button onclick="login()">Iniciar Sesi贸n</button>
            <p id="login-error" style="color: red; display: none;">Usuario o contrase帽a incorrectos</p>
        </div>
        
        <!-- Dashboard para el usuario Revisor (RH) -->
        <div class="dashboard" id="revisor-dashboard">
            <div class="header">
                <h1>Panel de Control - Revisor RH</h1>
                <div>
                    <span class="user-info">Hola Alejandra</span>
                    <button class="logout-btn" onclick="logout()">Cerrar Sesi贸n</button>
                </div>
            </div>
            
            <div class="tab-buttons">
                <button onclick="showTab('comparison-tab')">Espacio de Comparaci贸n</button>
            </div>
            
            <div id="comparison-tab" class="tab-content active">
                <h2>Espacio de Comparaci贸n</h2>
                <div style="display: flex; gap: 20px;">
                    <!-- Secci贸n de Excel -->
                    <div style="flex: 1;">
                        <h3>Datos de Excel</h3>
                        <div class="form-group">
                            <label for="excel-file">Cargar Archivo Excel:</label>
                            <input type="file" id="excel-file" accept=".xlsx, .xls">
                            <button onclick="loadExcel()">Cargar</button>
                        </div>
                        <div id="excel-data" style="margin-top: 20px; display: none;">
                            <div style="margin-bottom: 10px;">
                                <input type="text" id="search-input" placeholder="Buscar..." style="width: 300px;">
                                <button onclick="searchRows()">Buscar</button>
                            </div>
                            <div id="excel-row-viewer" style="border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
                                <h4>Fila <span id="current-row-index">1</span> de <span id="total-rows">0</span></h4>
                                <div id="excel-row-content"></div>
                                <div style="margin-top: 10px;">
                                    <button onclick="prevRow()" id="prev-row-btn" disabled>Anterior</button>
                                    <button onclick="nextRow()" id="next-row-btn">Siguiente</button>
                                </div>
                            </div>
                            <button onclick="saveChanges()">Guardar Cambios</button>
                            <button onclick="downloadExcel()">Descargar Excel Actualizado</button>
                        </div>
                    </div>
                    <!-- Secci贸n de PDF -->
                    <div style="flex: 1;">
                        <h3>Documentos PDF</h3>
                        <div class="form-group">
                            <label for="pdf-file">Cargar PDF:</label>
                            <input type="file" id="pdf-file" accept=".pdf" multiple>
                            <button onclick="loadPDFs()">Cargar</button>
                        </div>
                        <div id="pdf-list" class="pdf-section">
                            <div class="section-header">
                                <button onclick="togglePDFList()" class="toggle-btn">
                                    PDFs Cargados (<span id="pdf-count">0</span>)
                                </button>
                            </div>
                            <div class="pdf-search-container">
                                <input type="text" id="pdf-search-input" class="pdf-search-input" placeholder="Buscar PDF por nombre...">
                                <button onclick="searchPDFs()" class="pdf-search-btn">Buscar</button>
                            </div>
                            <div id="pdf-list-content" class="pdf-content"></div>
                        </div>
                        <div class="pdf-viewer" id="pdf-viewer" style="display: none;">
                            <h3 id="current-pdf-name"></h3>
                            <div class="pdf-container" id="pdf-container"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel de Confirmador: Espacio de Comparaci贸n -->
            <div id="confirmar-comparison-tab" class="tab-content">
                <h2>Espacio de Comparaci贸n</h2>
                <div style="display: flex; gap: 20px;">
                    <!-- Secci贸n de Excel -->
                    <div style="flex: 1;">
                        <h3>Revisi贸n de Datos</h3>
                        <div id="confirmador-excel-data" style="margin-top: 20px;">
                            <div style="margin-bottom: 10px;">
                                <input type="text" id="confirmador-search-input-comparacion" placeholder="Buscar..." style="width: 300px;">
                                <button onclick="searchConfirmadorRowsComparacion()">Buscar</button>
                            </div>
                            <div id="confirmador-row-viewer" style="border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
                                <h4>Fila <span id="confirmador-current-row-index">1</span> de <span id="confirmador-total-rows">0</span></h4>
                                <div id="confirmador-row-content"></div>
                                <div style="margin-top: 10px;">
                                    <button onclick="prevConfirmadorRow()" id="confirmador-prev-row-btn" disabled>Anterior</button>
                                    <button onclick="nextConfirmadorRow()" id="confirmador-next-row-btn">Siguiente</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Secci贸n de PDF -->
                    <div style="flex: 1;">
                        <h3>Firmar Documentos PDF</h3>
                        <div id="confirmador-pdf-list" class="pdf-section">
                            <div class="section-header">
                                <button onclick="toggleConfirmadorPDFList()" class="toggle-btn">
                                    PDFs Cargados (<span id="confirmador-pdf-count">0</span>)
                                </button>
                            </div>
                            <div class="pdf-search-container">
                                <input type="text" id="confirmador-search-input-pdf-comparacion" class="pdf-search-input confirmador-pdf-search" placeholder="Buscar PDF por nombre...">
                                <button onclick="searchConfirmadorPDFsComparacion(this)" class="pdf-search-btn">Buscar</button>
                            </div>
                            <div id="confirmador-pdf-list-content" class="pdf-content"></div>
                        </div>
                        <div class="pdf-viewer" id="confirmador-pdf-viewer" style="display: none;">
                            <h3 id="confirmador-current-pdf-name"></h3>
                            <div class="pdf-container" id="confirmador-pdf-container">
                                <div class="signature-container" style="margin-top: 20px; position: relative; z-index: 100;">
                                    <h3>Firma Digital</h3>
                                    <input type="file" id="signature-input-comparacion" class="signature-input" accept="image/*" onchange="handleFirmaUpload(event)">
                                    <div id="signature-placeholder-comparacion" class="signature-placeholder">
                                        <img id="signature-preview-comparacion" class="signature-preview" alt="Vista previa de la firma">
                                    </div>
                                    <div class="signature-buttons" style="margin-top: 10px; display: flex; gap: 10px; justify-content: center;">
                                        <button onclick="clearSignature()" style="padding: 8px 15px;">Limpiar</button>
                                        <button onclick="firmarPDF()" style="padding: 8px 15px;">Firmar Documento</button>
                                        <button onclick="firmarTodosPDFs()" style="padding: 8px 15px;">Firmar Todos los Documentos</button>
                                    </div>
                                </div>
                                <button onclick="aprobarTodosDocumentos()" class="approve-all-btn" style="margin-top: 20px; position: relative; z-index: 100;">Aprobar Todos los Documentos</button>
                            </div>
                            <div style="margin-top: 20px;">
                                <button onclick="firmarPDF()" id="download-signed-pdf" style="display: none;">Descargar PDF Firmado</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard para el usuario Confirmador -->
        <div class="dashboard" id="confirmador-dashboard" style="display: none;">
            <div class="header">
                <h1>Panel de Control - Directora RH</h1>
                <div>
                    <span class="user-info">Hola Andrea Amado</span>
                    <button class="logout-btn" onclick="logout()">Cerrar Sesi贸n</button>
                </div>
            </div>

            <div class="confirmador-content">
                <!-- Secci贸n de lista de empleados -->
                <div class="empleados-section">
                    <h2>Autorizaci贸n de Documento</h2>
                    <div class="search-container">
                        <input type="text" 
                               id="confirmador-search-input-empleados" 
                               placeholder="Buscar persona por nombre o identificaci贸n..." 
                               class="search-input" 
                               oninput="searchConfirmadorRowsEmpleados()">
                    </div>
                    <!-- Mensaje cuando no hay documentos -->
                    <div id="no-docs-message" style="display: none; padding: 15px; background: #fff3e0; border-radius: 4px; margin: 10px 0;">
                        No hay documentos para autorizar.
                    </div>
                    <!-- Lista de empleados -->
                    <div id="empleados-list" class="empleados-list"></div>
                </div>

                <!-- Secci贸n de detalles del empleado -->
                <div id="empleado-details" class="empleado-details">
                    <!-- Informaci贸n del empleado -->
                    <div class="empleado-info">
                        <h3>Detalles del Empleado</h3>
                        <div id="info-grid" class="info-grid"></div>
                    </div>

                    <!-- Secci贸n de PDFs -->
                    <div class="pdf-section">
                        <h3>Documentos PDF</h3>
                        <div class="pdf-search">
                            <input type="text" 
                                   id="pdf-search-input-empleado" 
                                   placeholder="Buscar PDF..." 
                                   class="search-input">
                        </div>
                        <div id="pdf-grid" class="pdf-grid"></div>
                    </div>

                    <!-- Secci贸n de firma -->
                    <div class="firma-section" style="display: none;">
                        <h3>Firma Digital</h3>
                        <div class="signature-container">
                            <input type="file" 
                                   id="signature-input-empleado" 
                                   class="signature-input" 
                                   accept="image/*" 
                                   onchange="handleFirmaUpload(event)">
                            <div id="signature-placeholder-empleado" class="signature-placeholder">
                                Haga clic aqu铆 para cargar su firma
                            </div>
                            <img id="signature-preview-empleado" class="signature-preview" alt="Vista previa de la firma">
                        </div>
                        <div class="signature-buttons">
                            <button onclick="clearSignature()">Limpiar</button>
                            <button onclick="firmarPDF()">Firmar Documento</button>
                            <button onclick="firmarTodosPDFs()">Firmar Todos los Documentos</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ixhsjtsilnfhuzgvkyve.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4aHNqdHNpbG5maHV6Z3ZreXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1MDA1NDYsImV4cCI6MjA2MTA3NjU0Nn0.pCrpF73wECI12ti_Vcew5q4a_WvSvsifiSQ-psolAv4';
        
        // Initialize Supabase client
        let supabase;
        try {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true
                }
            });
            console.log('Supabase initialized successfully');
        } catch (error) {
            console.error('Error initializing Supabase:', error);
        }

        // Variables globales
        let currentUser = null;
        let workbook = null;
        let currentPDF = null;
        let signatureData = null;
        let signedPDFs = {};
        let SIGNATURE_BASE64 = '';

        // Datos compartidos
        let sharedData = {
            excelData: null,
            currentRowIndex: 1,
            filteredRows: [],
            pdfs: {}
        };

        // Configuraci贸n de usuarios
        const users = {
            "RH": {
                password: "mr2025",
                role: "revisor"
            },
            "DirectoraRH": {
                password: "mr2025",
                role: "confirmador"
            }
        };


        // Funci贸n para buscar empleados (Confirmador)
        function searchConfirmadorRows() {
            try {
                const searchInput = document.getElementById('confirmador-search-input');
                if (!searchInput) {
                    console.error('No se encontr贸 el campo de b煤squeda');
                    return;
                }

                const searchTerm = searchInput.value.toLowerCase().trim();
                const empleadosList = document.getElementById('empleados-list');
                
                if (!empleadosList) {
                    console.error('No se encontr贸 la lista de empleados');
                    return;
                }

                if (!sharedData.excelData || !Array.isArray(sharedData.excelData) || sharedData.excelData.length <= 1) {
                    console.log('No hay datos para buscar');
                    empleadosList.innerHTML = '<p>No hay datos disponibles</p>';
                    return;
                }

                empleadosList.innerHTML = '';
                const headers = sharedData.excelData[0];
                
                // ndices de las columnas de b煤squeda
                const nombreIndex = headers.indexOf('NOMBRES Y APELLIDOS');
                const documentoIndex = headers.indexOf('No. DE IDENTIFICACIN');
                const estadoIndex = headers.indexOf('ESTADO');
                const cargoIndex = headers.indexOf('CARGO');

                let encontrados = false;

                for (let i = 1; i < sharedData.excelData.length; i++) {
                    const row = sharedData.excelData[i];
                    if (!row) continue;

                    const nombre = String(row[nombreIndex] || '').toLowerCase();
                    const documento = String(row[documentoIndex] || '').toLowerCase();
                    const cargo = String(row[cargoIndex] || '').toLowerCase();
                    const estado = row[estadoIndex] || 'SIN REVISION';

                    // Buscar en nombre, documento y cargo
                    if (searchTerm === '' || 
                        nombre.includes(searchTerm) || 
                        documento.includes(searchTerm) || 
                        cargo.includes(searchTerm)) {
                        
                        encontrados = true;
                        const empleadoCard = document.createElement('div');
                        empleadoCard.className = `empleado-card ${estado.toLowerCase().replace(' ', '-')}`;
                        empleadoCard.innerHTML = `
                            <div class="empleado-nombre">${row[nombreIndex] || 'Sin nombre'}</div>
                            <div class="empleado-info">
                                <span>Documento: ${row[documentoIndex] || 'N/A'}</span>
                                <span>Cargo: ${row[cargoIndex] || 'N/A'}</span>
                            </div>
                            <div class="empleado-estado">Estado: ${estado}</div>
                        `;
                        empleadoCard.onclick = () => showEmpleadoDetails(i);
                        empleadosList.appendChild(empleadoCard);
                    }
                }

                if (!encontrados) {
                    empleadosList.innerHTML = '<p>No se encontraron resultados</p>';
                }

            } catch (error) {
                console.error('Error en la b煤squeda:', error);
                alert('Error al buscar empleados: ' + error.message);
            }
        }

        // Subir firma a Supabase Storage y obtener URL p煤blica
        async function uploadFirmaToSupabase(file) {
            const filePath = `firmas/${file.name}`;
            // Subir el archivo (upsert para sobrescribir si ya existe)
            const { error } = await supabase.storage.from('firmas').upload(filePath, file, {
                cacheControl: '3600',
                upsert: true
            });
            if (error) throw error;
            // Obtener la URL p煤blica
            const { data: publicUrlData } = supabase.storage.from('firmas').getPublicUrl(filePath);
            return publicUrlData.publicUrl;
        }

        // Funci贸n para manejar la carga de firma
        async function handleFirmaUpload(event) {
            if (!currentUser || currentUser.role !== 'confirmador') {
                alert('Solo el rol de Confirmador puede cargar una firma.');
                event.target.value = '';
                return;
            }
            // Fijar la URL p煤blica de la firma directamente con doble barra
            window.firmaUrl = "https://ixhsjtsilnfhuzgvkyve.supabase.co/storage/v1/object/public/firmas//firma.png";
            document.querySelectorAll('.signature-preview').forEach(preview => {
                preview.src = window.firmaUrl;
                preview.style.display = 'block';
            });
            document.querySelectorAll('.signature-placeholder').forEach(placeholder => {
                placeholder.style.display = 'none';
            });
            alert('Firma cargada correctamente (usando la URL fija con doble barra).');
        }

        // Funci贸n para cargar Excel
        async function loadExcel() {
            try {
                const fileInput = document.getElementById('excel-file');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Por favor seleccione un archivo Excel');
                    return;
                }

                // Verificar el tipo de archivo
                const validTypes = [
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'application/vnd.ms-excel'
                ];
                if (!validTypes.includes(file.type)) {
                    alert('Por favor, seleccione un archivo Excel v谩lido (.xlsx o .xls)');
                    return;
                }

                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
                            throw new Error('El archivo Excel est谩 vac铆o o da帽ado');
                        }
                        
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        if (!firstSheet) {
                            throw new Error('No se pudo leer la hoja de c谩lculo');
                        }

                        // Convertir a JSON con manejo de errores
                        const newExcelData = XLSX.utils.sheet_to_json(firstSheet, { 
                            header: 1,
                            raw: false,
                            defval: '' // Valor por defecto para celdas vac铆as
                        });

                        if (!newExcelData || newExcelData.length <= 1) {
                            throw new Error('El archivo Excel no contiene datos suficientes');
                        }

                        // Guardar datos en el objeto compartido
                        sharedData.excelData = newExcelData;
                        sharedData.filteredRows = Array.from(
                            { length: newExcelData.length - 1 }, 
                            (_, i) => i + 1
                        );
                        sharedData.currentRowIndex = 1;

                        // Actualizar la interfaz
                        document.getElementById('excel-data').style.display = 'block';
                        document.getElementById('total-rows').textContent = sharedData.filteredRows.length;
                        displayExcelRow();

                        // Guardar en Supabase
                        try {
                            await saveToSupabase();
                            // Nueva integraci贸n: cargar tambi茅n en la tabla empleados
                            await cargarExcelASupabase(newExcelData);
                            console.log('Excel guardado en Supabase exitosamente');
                        } catch (supabaseError) {
                            console.error('Error al guardar en Supabase:', supabaseError);
                            alert('Los datos se cargaron correctamente pero hubo un error al guardarlos en la base de datos. Por favor, intente guardar los cambios manualmente.');
                        }

                    } catch (error) {
                        console.error('Error al procesar el Excel:', error);
                        alert('Error al procesar el archivo Excel: ' + error.message);
                        document.getElementById('excel-data').style.display = 'none';
                    }
                };

                reader.onerror = function(error) {
                    console.error('Error al leer el archivo:', error);
                    alert('Error al leer el archivo Excel. Por favor, intente nuevamente.');
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error al cargar el Excel:', error);
                alert('Error al cargar el archivo Excel: ' + error.message);
            }
        }

        // Funci贸n para compilar datos de Excel
        async function compileExcelData(newData, existingData) {
            try {
                if (!newData || newData.length <= 1) {
                    throw new Error('El archivo Excel est谩 vac铆o o no tiene datos suficientes');
                }

                // Obtener headers
                const headers = newData[0];
                // Buscar los 铆ndices usando encabezados normalizados
                const nombreIndex = headers.findIndex(h => normalizarTexto(h) === 'NOMBRES Y APELLIDOS');
                const documentoIndex = headers.findIndex(h => normalizarTexto(h) === 'NO DE IDENTIFICACION');

                // Validar columnas requeridas y mapear nombres de columnas
                const columnMapping = {
                    'NOMBRES Y APELLIDOS': ['NOMBRES Y APELLIDOS'],
                    'DOCUMENTO': ['No. DE IDENTIFICACIN', 'DOCUMENTO', 'No. DE IDENTIFICACION']
                };

                const columnasRequeridas = Object.keys(columnMapping);
                const columnasFaltantes = columnasRequeridas.filter(colReq => {
                    // Verificar si alguna de las variantes de la columna existe (normalizando)
                    return !columnMapping[colReq].some(variant => headers.some(h => normalizarTexto(h) === normalizarTexto(variant)));
                });

                if (columnasFaltantes.length > 0) {
                    throw new Error(`El archivo Excel debe contener las siguientes columnas obligatorias: ${columnasFaltantes.join(', ')}. \nColumnas encontradas en tu Excel: ${headers.join(', ')}`);
                }

                // Resto del c贸digo igual...
                const compiledData = [headers];
                const existingEmployees = new Map();

                if (existingData && existingData.length > 0) {
                    existingData.forEach(record => {
                        const employeeData = record.data;
                        if (employeeData && employeeData.length > 1) {
                            for (let i = 1; i < employeeData.length; i++) {
                                const row = employeeData[i];
                                if (row && row[nombreIndex] && row[documentoIndex]) {
                                    const key = `${row[nombreIndex]}_${row[documentoIndex]}`;
                                    existingEmployees.set(key, row);
                                }
                            }
                        }
                    });
                }

                // Procesar nuevos datos
                for (let i = 1; i < newData.length; i++) {
                    const row = newData[i];
                    if (!row) continue;

                    // Obtener nombre y documento con validaci贸n m谩s flexible
                    const nombre = row[nombreIndex]?.toString().trim();
                    const documento = row[documentoIndex]?.toString().trim();

                    // Si falta alg煤n dato requerido, registrar advertencia pero continuar
                    if (!nombre || !documento) {
                    //    console.warn(`Advertencia: Fila ${i + 1} tiene datos incompletos - Nombre: ${nombre || 'FALTA'}, Documento: ${documento || 'FALTA'}`);
                        // Continuar con la siguiente fila
                        continue;
                    }

                    const key = `${nombre}_${documento}`;
                    
                    if (existingEmployees.has(key)) {
                        const existingRow = existingEmployees.get(key);
                        const estadoIndex = headers.indexOf('ESTADO');
                        if (estadoIndex !== -1) {
                            row[estadoIndex] = existingRow[estadoIndex] || 'SIN REVISION';
                        }
                    }

                    compiledData.push(row);
                }

                // Guardar en Supabase
                const { error } = await supabase
                    .from('excel_data')
                    .insert([{
                        data: compiledData,
                        upload_date: new Date().toISOString()
                    }]);

                if (error) {
                    throw new Error('Error al guardar datos compilados: ' + error.message);
                }

                return compiledData;
            } catch (error) {
                console.error('Error al compilar datos:', error);
                alert(error.message);
                throw error;
            }
        }

        // Funci贸n para guardar cambios del revisor
        async function saveChanges() {
            try {
                if (!sharedData.excelData || !Array.isArray(sharedData.excelData)) {
                    throw new Error('No hay datos v谩lidos para guardar');
                }

                // Asegurarse de que exista la primera fila (headers)
                if (!sharedData.excelData[0]) {
                    throw new Error('El archivo Excel no tiene encabezados v谩lidos');
                }

                // A帽adir columnas si no existen
                const headers = sharedData.excelData[0];
                if (!headers.includes('ESTADO')) {
                    headers.push('ESTADO');
                }
                if (!headers.includes('PDF_ASOCIADO')) {
                    headers.push('PDF_ASOCIADO');
                }

                // Actualizar el estado de las filas y asociar PDFs
                for (let i = 1; i < sharedData.excelData.length; i++) {
                    if (!sharedData.excelData[i]) {
                        sharedData.excelData[i] = new Array(headers.length).fill('');
                        continue;
                    }

                    // Asegurarse de que la fila tenga todas las columnas
                    while (sharedData.excelData[i].length < headers.length) {
                        sharedData.excelData[i].push('');
                    }

                    const estadoIndex = headers.indexOf('ESTADO');
                    const pdfIndex = headers.indexOf('PDF_ASOCIADO');
                    const nombreIndex = headers.indexOf('NOMBRES Y APELLIDOS');

                    // Si no tiene estado, establecer como PENDIENTE
                    if (!sharedData.excelData[i][estadoIndex]) {
                        sharedData.excelData[i][estadoIndex] = 'PENDIENTE';
                    }

                    // Asociar PDF si no tiene uno y existe el nombre
                    if (!sharedData.excelData[i][pdfIndex] && nombreIndex >= 0) {
                        const nombreEmpleado = String(sharedData.excelData[i][nombreIndex] || '');
                        if (nombreEmpleado) {
                            const pdfAsociado = Object.keys(sharedData.pdfs || {}).find(filename => 
                                filename.toLowerCase().includes(nombreEmpleado.split(' ')[0].toLowerCase())
                            );
                            sharedData.excelData[i][pdfIndex] = pdfAsociado || '';
                        }
                    }
                }

                await saveToSupabase();
                alert('Cambios guardados correctamente. Los documentos est谩n listos para ser revisados por la Directora RH.');
            } catch (error) {
                console.error('Error al guardar cambios:', error);
                alert('Error al guardar los cambios: ' + error.message);
            }
        }

        // Funci贸n para guardar datos en Supabase
        async function saveToSupabase() {
            try {
                const dataToStore = {
                    excelData: sharedData.excelData,
                    pdfs: {},
                    last_updated: new Date().toISOString()
                };

                // Convertir ArrayBuffer a Base64 para los PDFs
                for (const filename in sharedData.pdfs) {
                    const arrayBuffer = sharedData.pdfs[filename];
                    console.log('Guardando PDF:', filename, arrayBuffer, typeof arrayBuffer, arrayBuffer instanceof ArrayBuffer);
                    if (arrayBuffer && (arrayBuffer instanceof ArrayBuffer || ArrayBuffer.isView(arrayBuffer))) {
                        const base64 = arrayBufferToBase64(arrayBuffer);
                        dataToStore.pdfs[filename] = base64;
                    } else {
                        console.warn('El PDF no es un ArrayBuffer v谩lido:', filename, arrayBuffer);
                    }
                }

                const { data, error } = await supabase
                    .from('shared_data')
                    .upsert([
                        {
                            id: 'current_data',
                            data: dataToStore
                        }
                    ]);

                if (error) throw error;
                console.log('Datos guardados en Supabase');
            } catch (error) {
                console.error('Error al guardar en Supabase:', error);
                throw error;
            }
        }

        // Funci贸n para mostrar una fila en el visor del Confirmador
        function displayConfirmadorRow() {
            if (!sharedData.excelData || sharedData.excelData.length <= 1) {
                const rowViewer = document.getElementById('confirmador-row-content');
                if (rowViewer) {
                    rowViewer.innerHTML = '<p>No hay datos disponibles</p>';
                }
                return;
            }
            
            const rowViewer = document.getElementById('confirmador-row-content');
            if (!rowViewer) return;
            
            const headers = sharedData.excelData[0];
            const rowIndex = sharedData.filteredRows[sharedData.currentRowIndex - 1];
            const rowData = sharedData.excelData[rowIndex] || [];
            
            rowViewer.innerHTML = '';
            
            headers.forEach((header, index) => {
                const div = document.createElement('div');
                div.className = 'form-group';
                
                if (header === 'ESTADO' || index === 45) {
                    const estadoOptions = ['SIN REVISION', 'PENDIENTE', 'REVISADO', 'AUTORIZADO'];
                    const currentValue = rowData[index] || 'SIN REVISION';
                    
                    div.innerHTML = `
                        <label>${header}</label>
                        <select class="estado-select" data-row="${rowIndex}" data-col="${index}">
                            ${estadoOptions.map(option => 
                                `<option value="${option}" ${currentValue === option ? 'selected' : ''}>${option}</option>`
                            ).join('')}
                        </select>
                    `;
                } else {
                    div.innerHTML = `
                        <label>${header}</label>
                        <input type="text" value="${rowData[index] || ''}" readonly>
                    `;
                }
                rowViewer.appendChild(div);
            });
            
            // Actualizar navegaci贸n
            document.getElementById('confirmador-current-row-index').textContent = sharedData.currentRowIndex;
            document.getElementById('confirmador-total-rows').textContent = sharedData.filteredRows.length;
            document.getElementById('confirmador-prev-row-btn').disabled = sharedData.currentRowIndex === 1;
            document.getElementById('confirmador-next-row-btn').disabled = sharedData.currentRowIndex === sharedData.filteredRows.length;
        }

        // Funci贸n para formatear fechas
        function formatDate(dateString) {
            if (!dateString) return '';
            
            try {
                // Si es una fecha en formato YYYY-MM-DD (desde input type="date")
                if (dateString.includes('-')) {
                    const [year, month, day] = dateString.split('-');
                    return `${day}/${month}/${year}`;
                }
                
                // Si es un n煤mero (fecha de Excel)
                if (!isNaN(dateString)) {
                    const date = new Date((dateString - 25569) * 86400 * 1000);
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                }
                
                return dateString;
            } catch (error) {
                console.error('Error al formatear fecha:', error);
                return dateString;
            }
        }
        
        // Funci贸n para alternar la visibilidad de la lista de PDFs (Revisor)
        function togglePDFList() {
            const content = document.getElementById('pdf-list-content');
            const button = document.querySelector('#pdf-list button');
            const isHidden = content.style.display === 'none';
            
            content.style.display = isHidden ? 'block' : 'none';
            button.classList.toggle('expanded', isHidden);
        }

        // Funci贸n para alternar la visibilidad de la lista de PDFs (Confirmador)
        function toggleConfirmadorPDFList() {
            const content = document.getElementById('confirmador-pdf-list-content');
            const button = document.querySelector('#confirmador-pdf-list button');
            const isHidden = content.style.display === 'none';
            
            content.style.display = isHidden ? 'block' : 'none';
            button.classList.toggle('expanded', isHidden);
        }
        // Funci贸n para cargar PDFs
        function loadPDFs() {
            const fileInput = document.getElementById('pdf-file');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Por favor seleccione al menos un archivo PDF');
                return;
            }
            
            // Limpiar la lista de PDFs anterior
            const pdfListContent = document.getElementById('pdf-list-content');
            pdfListContent.innerHTML = '';
            
            // Actualizar el contador
            document.getElementById('pdf-count').textContent = files.length;
            
            // Cargar cada PDF
            let loadedCount = 0;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = (function(file) {
                    return function(e) {
                        const pdfData = e.target.result; // Esto es un ArrayBuffer
                        sharedData.pdfs[file.name] = pdfData;
                        
                        // Crear miniatura
                        const thumbnail = document.createElement('div');
                        thumbnail.className = 'pdf-thumbnail';
                        thumbnail.innerHTML = `
                            <div style="width: 100px; height: 140px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd;">
                                <div style="text-align: center;">
                                    <div style="font-size: 40px; color: #666;"></div>
                                    <div style="font-size: 12px; color: #666;">PDF</div>
                                </div>
                            </div>
                            <div>${file.name}</div>
                        `;
                        thumbnail.onclick = function() {
                            displayPDF(file.name);
                        };
                        
                        pdfListContent.appendChild(thumbnail);
                        
                        // Incrementar contador y guardar cuando todos los PDFs est茅n cargados
                        loadedCount++;
                        if (loadedCount === files.length) {
                            saveToSupabase();
                            console.log('PDFs guardados en Supabase');
                            // Actualizar vista del confirmador si est谩 visible
                            const confirmadorDashboard = document.getElementById('confirmador-dashboard');
                            if (confirmadorDashboard && confirmadorDashboard.style.display === 'block') {
                                loadConfirmadorData();
                            }
                        }
                    };
                })(file);
                
                reader.readAsArrayBuffer(file);
            }
        }
        
        // Funci贸n para mostrar un PDF
        function displayPDF(filename) {
            console.log('displayPDF llamado con:', filename);
            if (!sharedData.pdfs[filename]) {
                alert('Error: PDF no encontrado.');
                return;
            }
            currentPDF = filename;
            console.log('currentPDF actualizado a:', currentPDF);

            document.getElementById('pdf-viewer').style.display = 'block';
            document.getElementById('current-pdf-name').textContent = filename;

            const container = document.getElementById('pdf-container');
            container.innerHTML = '';

            const pdfBlob = new Blob([sharedData.pdfs[filename]], { type: 'application/pdf' });
            const pdfUrl = URL.createObjectURL(pdfBlob);

            const iframe = document.createElement('iframe');
            iframe.src = pdfUrl;
            iframe.width = '100%';
            iframe.height = '100%';
            iframe.style.border = 'none';

            container.appendChild(iframe);
        }
        
        // Funci贸n para buscar PDFs (Revisor)
        function searchPDFs() {
            const searchTerm = document.getElementById('pdf-search-input').value.toLowerCase();
            const thumbnails = document.querySelectorAll('#pdf-list-content .pdf-thumbnail');
            
            thumbnails.forEach(thumbnail => {
                const pdfName = thumbnail.querySelector('div:last-child').textContent.toLowerCase();
                thumbnail.style.display = pdfName.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Funci贸n para mostrar detalles del empleado y su PDF asociado
        function showEmpleadoDetails(rowIndex) {
            if (!sharedData.excelData || !sharedData.excelData[rowIndex]) return;

            const headers = sharedData.excelData[0];
            const rowData = sharedData.excelData[rowIndex];
            
            // Mostrar el contenedor de detalles
            const detallesContainer = document.getElementById('empleado-details');
            detallesContainer.classList.add('active');
            
            // Mostrar informaci贸n del empleado
            const infoGrid = document.getElementById('info-grid');
            infoGrid.innerHTML = '';
            
            headers.forEach((header, index) => {
                const infoItem = document.createElement('div');
                infoItem.className = 'info-item';
                
                // Si es el campo ESTADO y el usuario es confirmador, mostrar select
                if (header === 'ESTADO' && currentUser && currentUser.role === 'confirmador') {
                    const estadoOptions = ['SIN REVISION', 'PENDIENTE', 'REVISADO', 'AUTORIZADO'];
                    const currentEstado = rowData[index] || 'SIN REVISION';
                    infoItem.innerHTML = `
                        <label>${header}</label>
                        <select class="form-control estado-select" data-row="${rowIndex}" data-col="${index}" onchange="updateEstadoEmpleado(this)">
                            ${estadoOptions.map(option => 
                                `<option value="${option}" ${currentEstado === option ? 'selected' : ''}>${option}</option>`
                            ).join('')}
                        </select>
                    `;
                } else {
                    // Para otros campos, mostrar el valor como texto
                    infoItem.innerHTML = `
                        <label>${header}</label>
                        <span>${rowData[index] || ''}</span>
                    `;
                }
                infoGrid.appendChild(infoItem);
            });

            // Mostrar PDFs disponibles
            const pdfGrid = document.getElementById('pdf-grid');
            pdfGrid.innerHTML = '';
            
            Object.keys(sharedData.pdfs).forEach(filename => {
                const pdfItem = document.createElement('div');
                pdfItem.className = 'pdf-item';
                pdfItem.innerHTML = `
                    <div class="pdf-icon"></div>
                    <div class="pdf-name">${filename}</div>
                `;
                pdfItem.onclick = () => displayConfirmadorPDF(filename);
                pdfGrid.appendChild(pdfItem);
            });

            // Configurar b煤squeda de PDFs
            const pdfSearchInput = document.getElementById('pdf-search-input-empleado');
            if (pdfSearchInput) {
                pdfSearchInput.oninput = () => {
                    const searchTerm = pdfSearchInput.value.toLowerCase();
                    const pdfItems = pdfGrid.querySelectorAll('.pdf-item');
                    
                    pdfItems.forEach(item => {
                        const pdfName = item.querySelector('.pdf-name').textContent.toLowerCase();
                        item.style.display = pdfName.includes(searchTerm) ? 'block' : 'none';
                    });
                };
            }
        }

        // Funci贸n para actualizar el estado del empleado
        async function updateEstadoEmpleado(selectElement) {
            try {
                const rowIndex = parseInt(selectElement.dataset.row);
                const colIndex = parseInt(selectElement.dataset.col);
                const newEstado = selectElement.value;

                if (!sharedData.excelData || !sharedData.excelData[rowIndex]) {
                    throw new Error('No se encontraron los datos del empleado');
                }

                // Actualizar el estado en los datos
                sharedData.excelData[rowIndex][colIndex] = newEstado;

                // Guardar cambios en Supabase
                await saveToSupabase();

                // Actualizar la vista de la lista de empleados
                const empleadosList = document.getElementById('empleados-list');
                if (empleadosList) {
                    const empleadoCards = empleadosList.querySelectorAll('.empleado-card');
                    empleadoCards[rowIndex - 1]?.classList.remove('sin-revision', 'pendiente', 'revisado', 'autorizado');
                    empleadoCards[rowIndex - 1]?.classList.add(newEstado.toLowerCase().replace(' ', '-'));
                    const estadoElement = empleadoCards[rowIndex - 1]?.querySelector('.empleado-estado');
                    if (estadoElement) {
                        estadoElement.textContent = `Estado: ${newEstado}`;
                    }
                }

                console.log('Estado actualizado correctamente');
            } catch (error) {
                console.error('Error al actualizar el estado:', error);
                alert('Error al actualizar el estado: ' + error.message);
            }
        }

        // Funci贸n para mostrar el di谩logo de firma
        function mostrarFirma() {
            const pdfContainer = document.getElementById('confirmador-pdf-container');
            const iframe = pdfContainer.querySelector('iframe');
            if (!iframe) return;

            // Aqu铆 implementaremos la l贸gica para mostrar el di谩logo de firma
            // y permitir firmar en la 煤ltima p谩gina del PDF
        }

        // Funci贸n para cerrar el visor de PDF
        function closePDFViewer() {
            document.getElementById('confirmador-pdf-viewer').style.display = 'none';
        }

        // Funci贸n para cargar datos del confirmador
        async function loadConfirmadorData() {
            console.log('Cargando datos del confirmador...');
            
            try {
                // Verificar que los elementos del DOM existan
                const noDocsMessage = document.getElementById('no-docs-message');
                const empleadosList = document.getElementById('empleados-list');
                
                if (!noDocsMessage || !empleadosList) {
                    console.error('Elementos del DOM no encontrados');
                    return;
                }

                const { data, error } = await supabase
                    .from('shared_data')
                    .select('data')
                    .eq('id', 'current_data')
                    .single();

                if (error) {
                    console.error('Error al obtener datos de Supabase:', error);
                    noDocsMessage.style.display = 'block';
                    noDocsMessage.textContent = 'Error al cargar los datos. Por favor, intente nuevamente.';
                    return;
                }

                if (!data || !data.data) {
                    console.log('No hay datos disponibles en Supabase');
                    noDocsMessage.style.display = 'block';
                    empleadosList.innerHTML = '';
                    return;
                }

                console.log('Datos recibidos de Supabase:', data);

                // Inicializar sharedData si no existe
                if (!window.sharedData) {
                    window.sharedData = {
                        excelData: null,
                        pdfs: {}
                    };
                }

                // Actualizar sharedData con los datos guardados
                if (data.data.excelData) {
                    sharedData.excelData = data.data.excelData;
                    console.log('Datos de Excel cargados:', sharedData.excelData.length, 'filas');
                }

                if (data.data.pdfs) {
                    sharedData.pdfs = {};
                    // Convertir Base64 a ArrayBuffer para los PDFs
                    for (const filename in data.data.pdfs) {
                        const base64 = data.data.pdfs[filename];
                        if (base64) {
                            try {
                                sharedData.pdfs[filename] = base64ToArrayBuffer(base64);
                                console.log('PDF cargado:', filename);
                            } catch (e) {
                                console.error('Error al convertir PDF:', filename, e);
                            }
                        }
                    }
                }

                // Actualizar la interfaz
                noDocsMessage.style.display = 'none';
                empleadosList.innerHTML = '';

                if (sharedData.excelData && sharedData.excelData.length > 1) {
                    const headers = sharedData.excelData[0];
                    const nombreIndex = headers.indexOf('NOMBRES Y APELLIDOS');
                    const estadoIndex = headers.indexOf('ESTADO');

                    if (nombreIndex === -1) {
                        console.error('Columna de nombres no encontrada');
                        return;
                    }

                    for (let i = 1; i < sharedData.excelData.length; i++) {
                        const row = sharedData.excelData[i];
                        if (!row) continue;

                        const estado = row[estadoIndex] || 'SIN REVISION';
                        const empleadoCard = document.createElement('div');
                        empleadoCard.className = `empleado-card ${estado.toLowerCase().replace(' ', '-')}`;
                        empleadoCard.innerHTML = `
                            <div class="empleado-nombre">${row[nombreIndex] || 'Sin nombre'}</div>
                            <div class="empleado-estado">Estado: ${estado}</div>
                        `;
                        empleadoCard.onclick = () => showEmpleadoDetails(i);
                        empleadosList.appendChild(empleadoCard);
                    }
                } else {
                    empleadosList.innerHTML = '<p>No hay datos de empleados disponibles</p>';
                }

                // Actualizar contador de PDFs
                const pdfCount = Object.keys(sharedData.pdfs).length;
                const pdfCountElement = document.getElementById('confirmador-pdf-count');
                if (pdfCountElement) {
                    pdfCountElement.textContent = pdfCount;
                }

                console.log('Carga de datos completada');

            } catch (error) {
                console.error('Error al cargar datos del confirmador:', error);
                if (noDocsMessage) {
                    noDocsMessage.style.display = 'block';
                    noDocsMessage.textContent = 'Error al cargar los datos. Por favor, intente nuevamente.';
                }
            }
        }

        // Funci贸n para actualizar la lista de PDFs del confirmador
        function updateConfirmadorPDFList() {
            const pdfListContent = document.getElementById('confirmador-pdf-list-content');
            if (!pdfListContent) return;

            pdfListContent.innerHTML = '';
            const pdfs = sharedData.pdfs;
            const pdfCount = Object.keys(pdfs).length;

            if (pdfCount > 0) {
                console.log('PDFs encontrados:', Object.keys(pdfs));
                Object.keys(pdfs).forEach(filename => {
                    const thumbnail = document.createElement('div');
                    thumbnail.className = 'pdf-thumbnail';
                    thumbnail.innerHTML = `
                        <div style="width: 100px; height: 140px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; cursor: pointer;">
                            <div style="text-align: center;">
                                <div style="font-size: 40px; color: #666;"></div>
                                <div style="font-size: 12px; color: #666;">PDF</div>
                            </div>
                        </div>
                        <div style="margin-top: 5px; text-align: center; font-size: 12px;">${filename}</div>
                    `;
                    thumbnail.onclick = () => displayConfirmadorPDF(filename);
                    pdfListContent.appendChild(thumbnail);
                });
            } else {
                pdfListContent.innerHTML = '<p style="text-align: center; color: #666;">No hay PDFs disponibles</p>';
            }
        }

        // Funci贸n para mostrar PDF en el visor del confirmador
        function displayConfirmadorPDF(filename) {
            console.log('Mostrando PDF:', filename);
            const pdfData = sharedData.pdfs[filename];
            if (!pdfData) {
                console.error('PDF no encontrado:', filename);
                alert('Error: PDF no encontrado.');
                return;
            }

            currentPDF = filename;

            let pdfViewer = document.getElementById('pdf-viewer-modal');
            if (!pdfViewer) {
                pdfViewer = document.createElement('div');
                pdfViewer.id = 'pdf-viewer-modal';
                pdfViewer.className = 'pdf-viewer-modal';
                document.body.appendChild(pdfViewer);
            }

            pdfViewer.innerHTML = `
                <div class="pdf-viewer-content">
                    <div class="pdf-viewer-header">
                        <h3>${filename}</h3>
                        <button onclick="closePDFViewer()" class="close-btn"></button>
                    </div>
                    <div class="pdf-container" id="pdf-container-modal"></div>
                    ${currentUser && currentUser.role === 'confirmador' ? `
                        <div class="firma-section">
                            <div class="signature-preview-container">
                                <img id="signature-display" src="${window.firmaUrl || ''}" alt="Firma" style="max-width: 200px; margin: 10px 0; ${window.firmaUrl ? '' : 'display: none;'}">
                            </div>
                            <button onclick="firmarPDF()" class="firma-btn">Firmar Documento</button>
                            <button onclick="firmarTodosPDFs()">Firmar Todos los Documentos</button>
                        </div>
                    ` : ''}
                </div>
            `;

            pdfViewer.style.display = 'flex';

            const pdfBlob = new Blob([pdfData], { type: 'application/pdf' });
            const pdfUrl = URL.createObjectURL(pdfBlob);
            const container = document.getElementById('pdf-container-modal');

            const iframe = document.createElement('iframe');
            iframe.src = pdfUrl;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            container.appendChild(iframe);
        }

        function closePDFViewer() {
            const pdfViewer = document.getElementById('pdf-viewer-modal');
            if (pdfViewer) {
                pdfViewer.style.display = 'none';
            }
        }

        async function firmarPDF() {
            try {
            if (!currentUser || currentUser.role !== 'confirmador') {
                alert('Solo el rol de Confirmador puede firmar documentos.');
                return;
            }

            if (!currentPDF || !sharedData.pdfs[currentPDF]) {
                alert('Por favor, seleccione un PDF antes de firmar.');
                return;
            }

            if (!window.firmaUrl) {
                alert('Por favor, cargue una firma antes de firmar.');
                return;
            }

                const pdfData = sharedData.pdfs[currentPDF];
                if (!(pdfData instanceof ArrayBuffer)) {
                    throw new Error('Los datos del PDF no son v谩lidos.');
                }

                try {
                const pdfDoc = await pdfjsLib.getDocument(pdfData).promise;
                    console.log('PDF cargado correctamente, p谩ginas:', pdfDoc.numPages);

                    const posicionFirma = await determinarPosicionFirmaContrato(pdfDoc);
                    console.log('Posici贸n de firma determinada:', posicionFirma);

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    format: 'a4',
                        unit: 'pt'  // Cambiar a puntos para mayor precisi贸n
                });

                    // Copiar p谩ginas
                    for (let i = 1; i <= pdfDoc.numPages; i++) {
                        const page = await pdfDoc.getPage(i);
                        const viewport = page.getViewport({ scale: 2.0 }); // Aumentamos la escala para mejor calidad

                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;

                        await page.render({
                            canvasContext: context,
                            viewport: viewport,
                            intent: 'print' // Mejor calidad de impresi贸n
                        }).promise;

                        const imgData = canvas.toDataURL('image/jpeg', 1.0); // M谩xima calidad JPEG
                        
                        if (i > 1) {
                            doc.addPage();
                        }

                        // A帽adir p谩gina con escala ajustada
                        doc.addImage(
                            imgData,
                            'JPEG',
                            0,
                            0,
                            doc.internal.pageSize.width,
                            doc.internal.pageSize.height,
                            undefined,
                            'FAST'
                        );

                        // Si es la 煤ltima p谩gina, a帽adir la firma
                        if (i === pdfDoc.numPages) {
                            try {
                                const response = await fetch(window.firmaUrl);
                                if (!response.ok) throw new Error('No se pudo descargar la imagen de la firma.');
                                const blob = await response.blob();
                                const reader = new FileReader();
                                const signatureDataUrl = await new Promise((resolve, reject) => {
                                    reader.onload = () => resolve(reader.result);
                                    reader.onerror = reject;
                                    reader.readAsDataURL(blob);
                                });

                                const img = new Image();
                                await new Promise((resolve, reject) => {
                                    img.onload = resolve;
                                    img.onerror = reject;
                                    img.src = signatureDataUrl;
                                });

                                // Obtener las coordenadas del QR y ajustarlas a la escala del PDF
                                const qrX = posicionFirma.x * (doc.internal.pageSize.width / (viewport.width / 2));
                                const qrY = posicionFirma.y * (doc.internal.pageSize.height / (viewport.height / 2));
                                const qrWidth = posicionFirma.width * (doc.internal.pageSize.width / (viewport.width / 2));
                                const qrHeight = posicionFirma.height * (doc.internal.pageSize.height / (viewport.height / 2));

                                // Ajustar la posici贸n vertical (subir la firma)
                                const offsetY = qrHeight * 0.15; // Subir un 15% de la altura del QR

                                // Borrar el QR
                                doc.setFillColor(255, 255, 255);
                                doc.rect(qrX, qrY - offsetY, qrWidth, qrHeight + offsetY, 'F');

                                // A帽adir la firma con mejor calidad
                                doc.addImage(
                                    img,
                                    'PNG',
                                    qrX,
                                    qrY - offsetY, // Aplicar el offset para subir la firma
                                    qrWidth,
                                    qrHeight,
                                    undefined,
                                    'FAST'
                                );

                            } catch (signatureError) {
                                console.error('Error al a帽adir la firma:', signatureError);
                                throw new Error('Error al a帽adir la firma al documento');
                            }
                        }
                    }

                    // Guardar el PDF firmado
                const signedFilename = `firmado_${currentPDF}`;
                    doc.save(signedFilename);
                alert('Documento firmado y descargado exitosamente.');

                } catch (error) {
                    console.error('Error al procesar el PDF:', error);
                    alert('Error al procesar el PDF: ' + error.message);
                }

            } catch (error) {
                console.error('Error al firmar el PDF:', error);
                alert('Error al firmar el documento: ' + error.message);
            }
        }

        // Funci贸n para determinar la posici贸n de la firma en contratos
        async function determinarPosicionFirmaContrato(pdfDoc) {
            try {
                // Obtener la 煤ltima p谩gina
                const lastPage = await pdfDoc.getPage(pdfDoc.numPages);
                const viewport = lastPage.getViewport({ scale: 2.0 }); // Aumentamos la escala para mejor detecci贸n
                
                // Crear un canvas temporal para analizar el contenido
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                // Renderizar la p谩gina con mayor calidad
                await lastPage.render({
                    canvasContext: context,
                    viewport: viewport,
                    intent: 'print'
                }).promise;

                // Obtener los datos de la imagen para detectar el QR
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                
                // Intentar detectar el QR
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (!code || code.data !== 'insertefirma') {
                    throw new Error('No se encontr贸 el c贸digo QR con el texto "insertefirma"');
                }

                console.log('QR detectado:', code.location);

                // Usar exactamente las coordenadas del QR detectado
                const scale = 2.0; // Mismo valor usado en viewport
                const calibracionY = 5; // Peque帽o ajuste hacia abajo
                const factorEscala = 1.2; // Factor para ajustar el tama帽o

                // Calcular dimensiones ajustadas
                const width = (code.location.bottomRightCorner.x - code.location.topLeftCorner.x) / scale;
                const height = (code.location.bottomRightCorner.y - code.location.topLeftCorner.y) / scale;
                
                // Calcular el centro del QR para mantener la firma centrada al escalar
                const centerX = code.location.topLeftCorner.x / scale;
                const centerY = (code.location.topLeftCorner.y / scale) + calibracionY;

                // Ajustar dimensiones con el factor de escala
                const newWidth = width * factorEscala;
                const newHeight = height * factorEscala;

                // Ajustar posici贸n para mantener centrado
                const adjustedX = centerX - ((newWidth - width) / 2);
                const adjustedY = centerY - ((newHeight - height) / 2);

                return {
                    x: adjustedX,
                    y: adjustedY,
                    width: newWidth,
                    height: newHeight,
                    pageWidth: viewport.width / scale,
                    pageHeight: viewport.height / scale
                };

            } catch (error) {
                console.error('Error al determinar posici贸n de firma:', error);
                throw error;
            }
        }

        // Funci贸n para verificar el QR espec铆fico
        function verificarQREspecifico(data, x, y, moduleSize, width, height) {
            // Patr贸n de posici贸n del QR (7x7 m贸dulos)
            const FINDER_PATTERN = [
                [1, 1, 1, 1, 1, 1, 1],
                [1, 0, 0, 0, 0, 0, 1],
                [1, 0, 1, 1, 1, 0, 1],
                [1, 0, 1, 1, 1, 0, 1],
                [1, 0, 1, 1, 1, 0, 1],
                [1, 0, 0, 0, 0, 0, 1],
                [1, 1, 1, 1, 1, 1, 1]
            ];

            // Verificar los tres patrones de posici贸n
            const positions = [
                {x: 0, y: 0},                    // Superior izquierda
                {x: 18 * moduleSize, y: 0},      // Superior derecha
                {x: 0, y: 18 * moduleSize}       // Inferior izquierda
            ];

            let totalConfidence = 0;
            let validPatterns = 0;

            // Verificar cada patr贸n de posici贸n
            for (const pos of positions) {
                let patternConfidence = 0;
                let totalPixels = 0;

                for (let py = 0; py < 7; py++) {
                    for (let px = 0; px < 7; px++) {
                        const pixelX = x + pos.x + px * moduleSize;
                        const pixelY = y + pos.y + py * moduleSize;
                        
                        if (pixelX >= width || pixelY >= height) continue;

                        const idx = (pixelY * width + pixelX) * 4;
                        const isBlack = esPixelNegro(data, idx);
                        
                        // Verificar si coincide con el patr贸n esperado
                        if ((FINDER_PATTERN[py][px] === 1 && isBlack) ||
                            (FINDER_PATTERN[py][px] === 0 && !isBlack)) {
                            patternConfidence++;
                        }
                        totalPixels++;
                    }
                }

                if (totalPixels > 0) {
                    const confidence = patternConfidence / totalPixels;
                    if (confidence > 0.8) {
                        validPatterns++;
                        totalConfidence += confidence;
                    }
                }
            }

            // Verificar el borde blanco (quiet zone)
            const quietZoneConfidence = verificarQuietZone(data, x, y, moduleSize * 25, width, height);

            // Calcular confianza final
            const finalConfidence = validPatterns === 3 ? 
                (totalConfidence / 3) * 0.8 + quietZoneConfidence * 0.2 : 0;

            return {
                confidence: finalConfidence
            };
        }

        // Funci贸n para verificar el borde blanco alrededor del QR
        function verificarQuietZone(data, x, y, size, width, height) {
            const QUIET_ZONE_SIZE = 4; // Tama帽o del borde blanco en m贸dulos
            let whitePixels = 0;
            let totalPixels = 0;

            // Verificar bordes superior e inferior
            for (let px = -QUIET_ZONE_SIZE; px < size + QUIET_ZONE_SIZE; px++) {
                // Borde superior
                for (let py = -QUIET_ZONE_SIZE; py < 0; py++) {
                    const pixelX = x + px;
                    const pixelY = y + py;
                    if (pixelX >= 0 && pixelX < width && pixelY >= 0 && pixelY < height) {
                        const idx = (pixelY * width + pixelX) * 4;
                        if (!esPixelNegro(data, idx)) whitePixels++;
                        totalPixels++;
                    }
                }
                // Borde inferior
                for (let py = size; py < size + QUIET_ZONE_SIZE; py++) {
                    const pixelX = x + px;
                    const pixelY = y + py;
                    if (pixelX >= 0 && pixelX < width && pixelY >= 0 && pixelY < height) {
                        const idx = (pixelY * width + pixelX) * 4;
                        if (!esPixelNegro(data, idx)) whitePixels++;
                        totalPixels++;
                    }
                }
            }

            // Verificar bordes izquierdo y derecho
            for (let py = 0; py < size; py++) {
                // Borde izquierdo
                for (let px = -QUIET_ZONE_SIZE; px < 0; px++) {
                    const pixelX = x + px;
                    const pixelY = y + py;
                    if (pixelX >= 0 && pixelX < width && pixelY >= 0 && pixelY < height) {
                        const idx = (pixelY * width + pixelX) * 4;
                        if (!esPixelNegro(data, idx)) whitePixels++;
                        totalPixels++;
                    }
                }
                // Borde derecho
                for (let px = size; px < size + QUIET_ZONE_SIZE; px++) {
                    const pixelX = x + px;
                    const pixelY = y + py;
                    if (pixelX >= 0 && pixelX < width && pixelY >= 0 && pixelY < height) {
                        const idx = (pixelY * width + pixelX) * 4;
                        if (!esPixelNegro(data, idx)) whitePixels++;
                        totalPixels++;
                    }
                }
            }

            return totalPixels > 0 ? whitePixels / totalPixels : 0;
        }

        // Funci贸n auxiliar para determinar si un pixel es negro
        function esPixelNegro(data, idx) {
            const r = data[idx];
            const g = data[idx + 1];
            const b = data[idx + 2];
            const brightness = (r + g + b) / 3;
            return brightness < 128;
        }
        
        // Funci贸n para buscar PDFs (Confirmador)
        function searchConfirmadorPDFs(button) {
            const searchContainer = button.closest('.pdf-search-container');
            const searchInput = document.getElementById('confirmador-search-input-pdf');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const pdfListContent = searchContainer.closest('.pdf-section').querySelector('.pdf-content');
            const thumbnails = pdfListContent.querySelectorAll('.pdf-thumbnail');
            
            thumbnails.forEach(thumbnail => {
                const pdfName = thumbnail.querySelector('div:last-child').textContent.toLowerCase();
                thumbnail.style.display = pdfName.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Funci贸n para mostrar una fila del Excel
        function displayExcelRow() {
            if (!sharedData.excelData || sharedData.excelData.length <= 1) {
                document.getElementById('excel-row-content').innerHTML = '<p>No hay datos disponibles</p>';
                return;
            }
            
            const headers = sharedData.excelData[0];
            const rowIndex = sharedData.filteredRows[sharedData.currentRowIndex - 1];
            const rowData = sharedData.excelData[rowIndex] || [];
            
            const rowContent = document.getElementById('excel-row-content');
            rowContent.innerHTML = '';

            // Definir las opciones para los campos de selecci贸n
            const selectOptions = {
                'TIPO DOCUMENTO IDENTIFICACIN': ['CC', 'PT', 'CE'],
                'CLAUSURA TERCERA': ['S', 'P'],
                'PARGRAFO DIRECCIN MANEJO Y CONFIANZA': ['S', 'A', 'P'],
                'NIVEL DE ESTUDIO': ['SIN ESCOLARIDAD', 'PRIMARIA', 'BACHILLER', 'TECNICO', 'TCNOLOGO', 'PROFESIONAL', 'MAESTRA', 'DOCTORADO', 'P'],
                'TARJETA-LICENCIA-MATRICULA-COPNIA': ['T', 'L', 'M', 'C'],
                'COMPETENCIAS TCNICAS CUMPLE/NO CUMPLE/NO APLICA': ['S', 'A', 'P'],
                'LICENCIA DE CONDUCCIN': ['S', 'P', 'A'],
                'EXPERIENCIA LABORAL': ['S', 'A', 'P'],
                'SIG-GR-F-42 SOLICITUD DE PERSONAL': ['S', 'P'],
                'CERTIFICADO DE RESIDENCIA': ['S', 'A', 'P'],
                'POSTULACIN APE': ['S', 'P'],
                'APROBACIN SSTA CARGOS': ['S', 'A', 'P'],
                'APROBACIN SSTA EMO': ['S', 'A', 'P'],
                'SAGRILAFT': ['S', 'P'],
                'ARL': ['S', 'P'],
                'CUENTA BANCARIA': ['S', 'P'],
                'SEXO': ['M', 'F'],
                'ESTADO CIVIL': ['S', 'U', 'C', 'D'],
                'CONFIRMACIN CONTRATACIN GERENCIA OPERACIONES': ['S', 'P'],
                'ESTADO': ['SIN REVISION', 'PENDIENTE', 'REVISADO', 'AUTORIZADO'],
                'SIG-GR-F-06 INDUCCIN': ['S', 'P'],
                'SIG-GR-F-31 FUNCIONES': ['S', 'P'],
                'SIG-GR-F-27 INFORMACIN TRABAJADOR': ['S', 'P'],
                'SIG-GR-F-04 DOTACIN Y EPPS': ['S', 'P'],
                'FORMATO MANEJO DE IMAGEN': ['S', 'P'],
                'AUTORIZACION MEDIOS ELECTRNICOS': ['S', 'P'],
                'SIG-GR-F-01 ENTREVISTA': ['S', 'P', 'A'],
                'SIG-GR-F-03 ASIGNACIN ROL': ['S', 'P', 'A'],
                'SIG-GR-F-37 HV CONDUCTORES': ['S', 'P', 'A'],
                'SIG-GR-F-61 PERFIL DEL CARGO, FUNCIONES Y RESPONSABILIDADES': ['S', 'P'],
                'HV DIGITAL COMPLETA SEGN SIG-GR-F-32': ['S', 'P'],
            };

            // Campos de texto libre
            const textAreas = [
                'TITULO',
                'CURSOS',
                'OBSERVACIONES',
                'EPS',
                'AFP',
                'CESANTIAS',
                'BANCO',
                'FECHA DE EXPEDICIN DOC. IDENTIDAD',
                'COMPETENCIAS TCNICAS'
            ];

            // Normalizar claves de selectOptions y textAreas
            const selectOptionsNorm = {};
            Object.keys(selectOptions).forEach(key => {
                selectOptionsNorm[normalizarTexto(key)] = selectOptions[key];
            });
            const textAreasNorm = textAreas.map(normalizarTexto);

            headers.forEach((header, index) => {
                const div = document.createElement('div');
                div.className = 'form-group';
                const headerNorm = normalizarTexto(header);
                const isDate = header.toLowerCase().includes('fecha');
                let value = rowData[index] || '';
                if (isDate && value) {
                    value = formatDate(value);
                }
                let inputHtml = '';
                if (selectOptionsNorm[headerNorm]) {
                    // Campo de selecci贸n
                    inputHtml = `
                        <select class="form-control" 
                                data-row="${rowIndex}" 
                                data-col="${index}">
                            <option value="">Seleccione...</option>
                            ${selectOptionsNorm[headerNorm].map(opt => 
                                `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`
                            ).join('')}
                        </select>`;
                } else if (textAreasNorm.includes(headerNorm)) {
                    // Campo de texto largo
                    inputHtml = `
                        <textarea class="form-control" 
                                 data-row="${rowIndex}" 
                                 data-col="${index}"
                                 rows="3">${value}</textarea>`;
                } else if (isDate) {
                    // Campo de fecha
                    inputHtml = `
                        <input type="text" 
                               value="${value}"
                               data-row="${rowIndex}"
                               data-col="${index}"
                               data-is-date="true"
                               placeholder="DD/MM/YYYY">`;
                } else {
                    // Campo de texto normal
                    inputHtml = `
                        <input type="text" 
                               value="${value}"
                               data-row="${rowIndex}"
                               data-col="${index}">`;
                }
                div.innerHTML = `
                    <label>${header}</label>
                    ${inputHtml}
                `;
                rowContent.appendChild(div);
            });
            
            // Actualizar navegaci贸n
            document.getElementById('current-row-index').textContent = sharedData.currentRowIndex;
            document.getElementById('prev-row-btn').disabled = sharedData.currentRowIndex === 1;
            document.getElementById('next-row-btn').disabled = sharedData.currentRowIndex === sharedData.filteredRows.length;

            // Agregar event listeners para los cambios
            const inputs = rowContent.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', function(e) {
                    const row = parseInt(this.dataset.row);
                    const col = parseInt(this.dataset.col);
                    const isDate = this.dataset.isDate === 'true';
                    let value = this.value;

                    if (isDate) {
                        value = formatDate(value);
                    }

                    if (row >= 0 && col >= 0) {
                        sharedData.excelData[row][col] = value;
                    }
                });
            });
        }

        // Funci贸n para navegar a la fila anterior
        function prevRow() {
            if (sharedData.currentRowIndex > 1) {
                sharedData.currentRowIndex--;
                displayExcelRow();
            }
        }

        // Funci贸n para navegar a la siguiente fila
        function nextRow() {
            if (sharedData.currentRowIndex < sharedData.filteredRows.length) {
                sharedData.currentRowIndex++;
                displayExcelRow();
            }
        }

        // Funci贸n para buscar en las filas
        function searchRows() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            sharedData.filteredRows = [];
            
            for (let i = 1; i < sharedData.excelData.length; i++) {
                const row = sharedData.excelData[i];
                if (row && row.some(cell => (cell || '').toString().toLowerCase().includes(searchTerm))) {
                    sharedData.filteredRows.push(i);
                }
            }
            
            sharedData.currentRowIndex = sharedData.filteredRows.length > 0 ? 1 : 0;
            displayExcelRow();
            
            document.getElementById('total-rows').textContent = sharedData.filteredRows.length;
            
            if (sharedData.filteredRows.length === 0) {
                document.getElementById('excel-row-content').innerHTML = '<p>No se encontraron resultados</p>';
            }
        }

        // Funci贸n para descargar el Excel actualizado
        async function downloadExcel() {
            try {
                // Consultar todos los empleados desde Supabase
                const { data, error } = await supabase.from('empleados').select('*');
                if (error) {
                    alert('Error al obtener los empleados: ' + error.message);
                    return;
                }
                if (!data || data.length === 0) {
                    alert('No hay empleados almacenados.');
                    return;
                }

                // Definir el orden de las columnas seg煤n el Excel original
                const columnOrder = [
                    'item',
                    'tipo_contrato',
                    'nombres_y_apellidos',
                    'tipo_documento_identificacion',
                    'no_de_identificacion',
                    'lugar_expedicion_documento_identificacion',
                    'fecha_de_nacimiento',
                    'lugar_de_nacimiento',
                    'nacionalidad',
                    'direccion_de_residencia',
                    'municipio_departamento_residencia',
                    'telefono_celular',
                    'correo_electronico',
                    'cargo',
                    'categoria_tabla',
                    'proyecto_y_o_orden_de_servicio',
                    'obra_o_labor_contratada',
                    'lugar_de_ejecucion',
                    'fecha_de_inicio',
                    'periodo_de_prueba',
                    'fecha_terminacion',
                    'salario',
                    'salario_letras',
                    'clausura_tercera',
                    'horario_laboral',
                    'paragrafo_direccion_manejo_y_confianza',
                    'fecha_firma_contrato',
                    'nivel_de_estudio',
                    'titulo',
                    'tarjeta_licencia_matricula_copnia',
                    'competencias_tecnicas_cumple_no_cumple_no_aplica',
                    'cursos',
                    'licencia_de_conduccion',
                    'experiencia_laboral',
                    'sig_gr_f_42_solicitud_de_personal',
                    'certificado_de_residencia',
                    'postulacion_ape',
                    'aprobacion_ssta_cargos',
                    'aprobacion_ssta_emo',
                    'sagrilaft',
                    'arl',
                    'eps',
                    'afp',
                    'cesantias',
                    'cuenta_bancaria',
                    'banco',
                    'fecha_expedicion_doc_identidad',
                    'sexo',
                    'estado_civil',
                    'confirmacion_contratacion_gerencia_operaciones',
                    'observaciones',
                    'estado',
                    'sig_gr_f_06_induccion',
                    'sig_gr_f_31_funciones',
                    'sig_gr_f_27_informacion_trabajador',
                    'sig_gr_f_04_dotacion_y_epps',
                    'formato_manejo_de_imagen',
                    'autorizacion_medios_electronicos',
                    'sig_gr_f_01_entrevista',
                    'sig_gr_f_03_asignacion_rol',
                    'sig_gr_f_37_hv_conductores',
                    'sig_gr_f_61_perfil_del_cargo_funciones_y_responsabilidades',
                    'hv_digital_completa_segun_sig_gr_f_32'
                ];

                // Convertir los nombres de columnas a formato legible
                const headers = columnOrder.map(col => {
                    return col
                        .split('_')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ')
                        .replace(/([a-z])([A-Z])/g, '$1 $2')
                        .toUpperCase();
                });

                // Preparar los datos en el orden correcto
                const rows = data.map(obj => 
                    columnOrder.map(key => obj[key] || '')
                );

                // Crear el libro de trabajo y la hoja
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);

                // Configurar el ancho de las columnas
                const columnWidths = headers.map(header => ({
                    wch: Math.max(20, header.length * 1.2)
                }));
                ws['!cols'] = columnWidths;

                // Aplicar estilos a los encabezados
                const headerStyle = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4CAF50" } },
                    alignment: { horizontal: "center", vertical: "center", wrapText: true }
                };

                // Aplicar estilos a las celdas de datos
                const dataStyle = {
                    alignment: { vertical: "center", wrapText: true },
                    border: {
                        top: { style: "thin" },
                        bottom: { style: "thin" },
                        left: { style: "thin" },
                        right: { style: "thin" }
                    }
                };

                // Aplicar estilos a todas las celdas
                for (let i = 0; i < rows.length + 1; i++) {
                    for (let j = 0; j < headers.length; j++) {
                        const cellRef = XLSX.utils.encode_cell({ r: i, c: j });
                        if (!ws[cellRef]) ws[cellRef] = { v: "" };
                        
                        if (i === 0) {
                            // Estilos para encabezados
                            ws[cellRef].s = headerStyle;
                        } else {
                            // Estilos para datos
                            ws[cellRef].s = dataStyle;
                        }
                    }
                }

                // Establecer el rango de la hoja
                ws['!ref'] = XLSX.utils.encode_range({
                    s: { c: 0, r: 0 },
                    e: { c: headers.length - 1, r: rows.length }
                });

                // A帽adir la hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, 'Empleados');

                // Descargar el archivo
                const wbout = XLSX.write(wb, { 
                    bookType: 'xlsx', 
                    type: 'array',
                    cellStyles: true
                });
                
                const blob = new Blob([wbout], { type: 'application/octet-stream' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'empleados_supabase.xlsx';
                a.click();
                window.URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error al descargar el Excel desde Supabase:', error);
                alert('Error al descargar el archivo Excel desde Supabase');
            }
        }

        // Funci贸n para mostrar los empleados en la lista
        function displayEmpleadosList() {
            const empleadosList = document.getElementById('empleados-list');
            if (!empleadosList || !sharedData.excelData || sharedData.excelData.length <= 1) return;

            empleadosList.innerHTML = '';
            const headers = sharedData.excelData[0];
            const nombreIndex = headers.indexOf('NOMBRES Y APELLIDOS');
            const estadoIndex = headers.indexOf('ESTADO');

            for (let i = 1; i < sharedData.excelData.length; i++) {
                const row = sharedData.excelData[i];
                if (!row) continue;

                const estado = row[estadoIndex] || 'SIN REVISION';
                const empleadoCard = document.createElement('div');
                empleadoCard.className = 'empleado-card';
                empleadoCard.classList.add(estado.toLowerCase().replace(' ', '-'));
                empleadoCard.innerHTML = `
                    <div class="empleado-nombre">${row[nombreIndex] || 'Sin nombre'}</div>
                    <div class="empleado-estado">${estado}</div>
                `;
                empleadoCard.onclick = () => showEmpleadoDetails(i);
                empleadosList.appendChild(empleadoCard);
            }
        }

        // Funci贸n para convertir ArrayBuffer a Base64
        function arrayBufferToBase64(buffer) {
            if (!buffer) throw new Error('Buffer vac铆o');
            let bytes;
            if (buffer instanceof ArrayBuffer) {
                bytes = new Uint8Array(buffer);
            } else if (ArrayBuffer.isView(buffer)) {
                bytes = new Uint8Array(buffer.buffer);
            } else {
                throw new Error('No es un ArrayBuffer ni un TypedArray');
            }
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // Funci贸n para convertir Base64 a ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Funci贸n de inicio de sesi贸n
        async function login() {
            try {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('login-error');
                
                if (!users[username]) {
                    loginError.textContent = 'Usuario no encontrado';
                    loginError.style.display = 'block';
                    return;
                }

                if (users[username].password !== password) {
                    loginError.textContent = 'Contrase帽a incorrecta';
                    loginError.style.display = 'block';
                    return;
                }

                currentUser = {
                    username: username,
                    role: users[username].role
                };
                
                // Fijar la URL p煤blica de la firma para el confirmador
                if (currentUser.role === 'confirmador') {
                    window.firmaUrl = "https://ixhsjtsilnfhuzgvkyve.supabase.co/storage/v1/object/public/firmas//firma.png";
                    // Mostrar la firma en la interfaz
                    document.querySelectorAll('.signature-preview').forEach(preview => {
                        preview.src = window.firmaUrl;
                        preview.style.display = 'block';
                    });
                    document.querySelectorAll('.signature-placeholder').forEach(placeholder => {
                        placeholder.style.display = 'none';
                    });
                }

                // Ocultar formulario de login
                document.getElementById('login-form').style.display = 'none';
                loginError.style.display = 'none';

                if (currentUser.role === 'revisor') {
                    document.getElementById('revisor-dashboard').style.display = 'block';
                    showTab('comparison-tab');
                } else if (currentUser.role === 'confirmador') {
                    const confirmadorDashboard = document.getElementById('confirmador-dashboard');
                    confirmadorDashboard.style.display = 'block';
                    await new Promise(resolve => setTimeout(resolve, 100));
                    const requiredElements = [
                        'no-docs-message',
                        'empleados-list',
                        'empleado-details',
                        'info-grid',
                        'pdf-grid'
                    ];
                    const missingElements = requiredElements.filter(id => !document.getElementById(id));
                    if (missingElements.length > 0) {
                        console.error('Elementos faltantes:', missingElements);
                        throw new Error('No se encontraron todos los elementos necesarios en el DOM');
                    }
                    await loadConfirmadorData();
                    initRealtimeSubscription();
                }
            } catch (error) {
                console.error('Error durante el inicio de sesi贸n:', error);
                const loginError = document.getElementById('login-error');
                loginError.textContent = 'Error al iniciar sesi贸n. Por favor, intente nuevamente.';
                loginError.style.display = 'block';
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('revisor-dashboard').style.display = 'none';
                document.getElementById('confirmador-dashboard').style.display = 'none';
            }
        }

        // Funci贸n para cerrar sesi贸n
        async function logout() {
            try {
                if (currentUser && supabase) {
                    try {
                        await supabase.channel('online-users').unsubscribe();
                        await supabase.channel('document-changes').unsubscribe();
                    } catch (error) {
                        console.error('Error al desconectar de Supabase:', error);
                    }
                }
            } finally {
                currentUser = null;
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('revisor-dashboard').style.display = 'none';
                document.getElementById('confirmador-dashboard').style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        }

        // Funci贸n para mostrar pesta帽as
        function showTab(tabId) {
            console.log('Mostrando tab:', tabId);
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
                tabContents[i].style.display = 'none';
            }
            
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
                
                // Si es el tab del confirmador, cargar los datos
                if (tabId === 'confirmar-comparison-tab') {
                    loadConfirmadorData();
                }
            }
        }

        // Funci贸n para inicializar la suscripci贸n a cambios en tiempo real
        function initRealtimeSubscription() {
            if (currentUser && currentUser.role === 'confirmador') {
                supabase
                    .channel('shared_data_changes')
                    .on('postgres_changes', 
                        {
                            event: '*',
                            schema: 'public',
                            table: 'shared_data'
                        },
                        (payload) => {
                            console.log('Cambios detectados en Supabase');
                            loadConfirmadorData();
                        }
                    )
                    .subscribe();
            }
        }

        // Funci贸n para aprobar todos los documentos
        async function aprobarTodosDocumentos() {
            try {
                // Verificar si el usuario tiene permisos
                if (!currentUser || currentUser.role !== 'confirmador') {
                    alert('Solo los autorizadores pueden aprobar documentos.');
                    return;
                }

                // Verificar firma
                if (!signatureData) {
                    alert('Por favor, cargue una firma antes de aprobar los documentos');
                    return;
                }

                // Verificar si hay documentos para aprobar
                if (!sharedData.excelData || sharedData.excelData.length <= 1) {
                    alert('No hay documentos para aprobar');
                    return;
                }

                const headers = sharedData.excelData[0];
                const estadoIndex = headers.indexOf('ESTADO');
                const pdfIndex = headers.indexOf('PDF_ASOCIADO');

                // Recopilar documentos pendientes
                const pendingDocs = [];
                for (let i = 1; i < sharedData.excelData.length; i++) {
                    const row = sharedData.excelData[i];
                    if (row && row[estadoIndex] === 'PENDIENTE' && row[pdfIndex]) {
                        pendingDocs.push({
                            rowIndex: i,
                            pdfName: row[pdfIndex]
                        });
                    }
                }

                if (pendingDocs.length === 0) {
                    alert('No hay documentos pendientes para aprobar');
                    return;
                }

                // Procesar cada PDF
                const zip = new JSZip();
                for (const doc of pendingDocs) {
                    try {
                        const pdfData = sharedData.pdfs[doc.pdfName];
                        if (!pdfData) continue;

                        // Cargar el PDF
                        const pdfDoc = await pdfjsLib.getDocument(pdfData).promise;
                        const numPages = pdfDoc.numPages;

                        // Crear nuevo documento PDF con firma
                        const { jsPDF } = window.jspdf;
                        const newPdf = new jsPDF();

                        // A帽adir la firma en la 煤ltima p谩gina
                        const img = new Image();
                        img.src = signatureData;
                        await new Promise((resolve) => { img.onload = resolve; });
                        
                        newPdf.addImage(
                            img, 
                            'PNG', 
                            newPdf.internal.pageSize.width - 70, 
                            newPdf.internal.pageSize.height - 60, 
                            50, 
                            30
                        );

                        // A帽adir al ZIP
                        const pdfBytes = newPdf.output('arraybuffer');
                        zip.file(`firmado_${doc.pdfName}`, pdfBytes);

                        // Actualizar estado en Excel
                        sharedData.excelData[doc.rowIndex][estadoIndex] = 'AUTORIZADO';
                    } catch (error) {
                        console.error(`Error al procesar PDF ${doc.pdfName}:`, error);
                    }
                }

                // A帽adir Excel actualizado al ZIP
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(sharedData.excelData);
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Documentos');
                const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                zip.file('documentos_actualizados.xlsx', excelBuffer);

                // Generar y descargar ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = window.URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'documentos_aprobados.zip';
                a.click();
                window.URL.revokeObjectURL(url);

                // Guardar cambios en Supabase
                await saveToSupabase();

                // Actualizar interfaz
                document.getElementById('estado-message').textContent = 'Estado: Documentos autorizados y descargados exitosamente';
                alert('Todos los documentos han sido aprobados y descargados exitosamente');

            } catch (error) {
                console.error('Error al aprobar los documentos:', error);
                alert('Error al aprobar los documentos: ' + error.message);
            }
        }

        // Funci贸n para actualizar el estado del documento en el Excel seg煤n el nombre del PDF
        function updateDocumentStatus(pdfName, nuevoEstado) {
            if (!sharedData.excelData) return;
            const headers = sharedData.excelData[0];
            const pdfIndex = headers.indexOf('PDF_ASOCIADO');
            const estadoIndex = headers.indexOf('ESTADO');
            for (let i = 1; i < sharedData.excelData.length; i++) {
                const row = sharedData.excelData[i];
                if (row && row[pdfIndex] === pdfName) {
                    row[estadoIndex] = nuevoEstado;
                    break;
                }
            }
        }

        // Funci贸n para clonar un ArrayBuffer
        function cloneArrayBuffer(buffer) {
            if (!buffer) return buffer;
            return buffer.slice(0);
        }

        // Funci贸n para convertir fechas a formato YYYY-MM-DD
        function formatearFecha(valor) {
            if (!valor) return null;
            // Si ya es formato YYYY-MM-DD
            if (/^\d{4}-\d{2}-\d{2}$/.test(valor)) return valor;
            // Si es formato DD/MM/YYYY
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(valor)) {
                const [d, m, y] = valor.split('/');
                return `${y}-${m}-${d}`;
            }
            // Si es un n煤mero de Excel (fecha serial)
            if (!isNaN(valor)) {
                const date = new Date((valor - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            return valor;
        }

        // Funci贸n para cargar y actualizar datos del Excel en la tabla empleados
        async function cargarExcelASupabase(excelData) {
            const mapeoColumnas = {
                'item': 'item',
                'tipo_contrato': 'tipo_contrato',
                'nombres_y_apellidos': 'nombres_y_apellidos',
                'tipo_documento_identificacion': 'tipo_documento_identificacion',
                'no_de_identificacion': 'no_de_identificacion',
                'lugar_expedicion_documento_identificacion': 'lugar_expedicion_documento_identificacion',
                'fecha_de_nacimiento': 'fecha_de_nacimiento',
                'lugar_de_nacimiento': 'lugar_de_nacimiento',
                'nacionalidad': 'nacionalidad',
                'direccion_de_residencia': 'direccion_de_residencia',
                'municipio_departamento_residencia': 'municipio_departamento_residencia',
                'telefono_celular': 'telefono_celular',
                'correo_electronico': 'correo_electronico',
                'cargo': 'cargo',
                'categoria_tabla': 'categoria_tabla',
                'proyecto_y_o_orden_de_servicio': 'proyecto_y_o_orden_de_servicio',
                'obra_o_labor_contratada': 'obra_o_labor_contratada',
                'lugar_de_ejecucion': 'lugar_de_ejecucion',
                'fecha_de_inicio': 'fecha_de_inicio',
                'periodo_de_prueba': 'periodo_de_prueba',
                'fecha_terminacion': 'fecha_terminacion',
                'salario': 'salario',
                'salario_letras': 'salario_letras',
                'clausura_tercera': 'clausura_tercera',
                'horario_laboral': 'horario_laboral',
                'paragrafo_direccion_manejo_y_confianza': 'paragrafo_direccion_manejo_y_confianza',
                'fecha_firma_contrato': 'fecha_firma_contrato',
                'nivel_de_estudio': 'nivel_de_estudio',
                'titulo': 'titulo',
                'tarjeta_licencia_matricula_copnia': 'tarjeta_licencia_matricula_copnia',
                'competencias_tecnicas_cumple_no_cumple_no_aplica': 'competencias_tecnicas_cumple_no_cumple_no_aplica',
                'cursos': 'cursos',
                'licencia_de_conduccion': 'licencia_de_conduccion',
                'experiencia_laboral': 'experiencia_laboral',
                'sig_gr_f_42_solicitud_de_personal': 'sig_gr_f_42_solicitud_de_personal',
                'certificado_de_residencia': 'certificado_de_residencia',
                'postulacion_ape': 'postulacion_ape',
                'aprobacion_ssta_cargos': 'aprobacion_ssta_cargos',
                'aprobacion_ssta_emo': 'aprobacion_ssta_emo',
                'sagrilaft': 'sagrilaft',
                'arl': 'arl',
                'eps': 'eps',
                'afp': 'afp',
                'cesantias': 'cesantias',
                'cuenta_bancaria': 'cuenta_bancaria',
                'banco': 'banco',
                'fecha_expedicion_doc_identidad': 'fecha_expedicion_doc_identidad',
                'sexo': 'sexo',
                'estado_civil': 'estado_civil',
                'confirmacion_contratacion_gerencia_operaciones': 'confirmacion_contratacion_gerencia_operaciones',
                'observaciones': 'observaciones',
                'estado': 'estado',
                'sig_gr_f_06_induccion': 'sig_gr_f_06_induccion',
                'sig_gr_f_31_funciones': 'sig_gr_f_31_funciones',
                'sig_gr_f_27_informacion_trabajador': 'sig_gr_f_27_informacion_trabajador',
                'sig_gr_f_04_dotacion_y_epps': 'sig_gr_f_04_dotacion_y_epps',
                'formato_manejo_de_imagen': 'formato_manejo_de_imagen',
                'autorizacion_medios_electronicos': 'autorizacion_medios_electronicos',
                'sig_gr_f_01_entrevista': 'sig_gr_f_01_entrevista',
                'sig_gr_f_03_asignacion_rol': 'sig_gr_f_03_asignacion_rol',
                'sig_gr_f_37_hv_conductores': 'sig_gr_f_37_hv_conductores',
                'sig_gr_f_61_perfil_del_cargo_funciones_y_responsabilidades': 'sig_gr_f_61_perfil_del_cargo_funciones_y_responsabilidades',
                'hv_digital_completa_segun_sig_gr_f_32': 'hv_digital_completa_segun_sig_gr_f_32'
            };
            const columnasTabla = Object.values(mapeoColumnas);
            const headers = excelData[0];
            for (let i = 1; i < excelData.length; i++) {
                const fila = excelData[i];
                // Filtrar filas vac铆as o con solo celdas vac铆as
                if (!fila || fila.every(cell => !cell || cell.toString().trim() === '')) continue;
                const registro = {};
                headers.forEach((col, idx) => {
                    // Normalizar encabezado
                    let key = col
                        .toLowerCase()
                        .replace(/[谩盲芒]/g, 'a')
                        .replace(/[茅猫毛锚]/g, 'e')
                        .replace(/[铆矛茂卯]/g, 'i')
                        .replace(/[贸貌枚么]/g, 'o')
                        .replace(/[煤霉眉没]/g, 'u')
                        .replace(/帽/g, 'n')
                        .replace(/[^a-z0-9_ ]/g, '')
                        .replace(/\s+/g, '_')
                        .trim();
                    const columnaSupabase = mapeoColumnas[key];
                    if (columnaSupabase) {
                        registro[columnaSupabase] = fila[idx] || null;
                    }
                });
                // Validar campos obligatorios
                if (!registro.nombres_y_apellidos || !registro.no_de_identificacion) continue;
                // Filtrar solo columnas v谩lidas
                Object.keys(registro).forEach(key => {
                    if (!columnasTabla.includes(key)) {
                        delete registro[key];
                    }
                });
                // Convertir fechas a formato YYYY-MM-DD si aplica
                [
                    'fecha_de_nacimiento',
                    'fecha_de_inicio',
                    'fecha_terminacion',
                    'fecha_firma_contrato',
                    'fecha_expedicion_doc_identidad'
                ].forEach(campoFecha => {
                    if (registro[campoFecha]) registro[campoFecha] = formatearFecha(registro[campoFecha]);
                });
                // Guardar en Supabase
                const { error } = await supabase
                    .from('empleados')
                    .upsert([registro], { onConflict: 'no_de_identificacion' });
                if (error) {
                    console.error('Error al guardar en Supabase:', error);
                }
            }
            alert('Datos cargados/actualizados en la base de datos.');
        }

        // Funci贸n para normalizar encabezados (quita tildes, espacios extra y saltos de l铆nea)
        function normalizarTexto(texto) {
            return texto
                .toUpperCase()
                .replace(/[]/g, 'A')
                .replace(/[]/g, 'E')
                .replace(/[]/g, 'I')
                .replace(/[]/g, 'O')
                .replace(/[]/g, 'U')
                .replace(//g, 'N')
                .replace(/[^A-Z0-9 ]/g, '')
                .replace(/\s+/g, ' ')
                .replace(/\r?\n|\r/g, ' ')
                .trim();
        }

        // Funci贸n para firmar todos los PDFs y descargarlos en un ZIP
        async function firmarTodosPDFs() {
            try {
                if (!currentUser || currentUser.role !== 'confirmador') {
                    alert('Solo el rol de Confirmador puede firmar documentos.');
                    return;
                }

                if (!window.firmaUrl) {
                    alert('Por favor, cargue una firma antes de continuar.');
                    return;
                }

                // Verificar si hay PDFs disponibles
                const pdfs = Object.entries(sharedData.pdfs);
                if (pdfs.length === 0) {
                    alert('No hay documentos para firmar.');
                    return;
                }

                // Crear un nuevo objeto ZIP
                const zip = new JSZip();
                
                // Mostrar indicador de progreso
                const progressDiv = document.createElement('div');
                progressDiv.style.position = 'fixed';
                progressDiv.style.top = '50%';
                progressDiv.style.left = '50%';
                progressDiv.style.transform = 'translate(-50%, -50%)';
                progressDiv.style.padding = '20px';
                progressDiv.style.background = 'white';
                progressDiv.style.border = '1px solid #ccc';
                progressDiv.style.borderRadius = '5px';
                progressDiv.style.zIndex = '1000';
                document.body.appendChild(progressDiv);

                let processedCount = 0;
                for (const [pdfName, pdfData] of pdfs) {
                    try {
                        progressDiv.textContent = `Procesando documento ${processedCount + 1} de ${pdfs.length}: ${pdfName}`;
                        
                        // Convertir ArrayBuffer a Blob
                        const pdfBlob = new Blob([pdfData], { type: 'application/pdf' });
                        
                        // Firmar el PDF
                        const signedPdfBlob = await procesarYFirmarPDF(pdfBlob);
                        
                        // A帽adir al ZIP
                        zip.file(`firmado_${pdfName}`, signedPdfBlob);
                        
                        processedCount++;
                    } catch (error) {
                        console.error(`Error procesando PDF ${pdfName}:`, error);
                    }
                }

                // Generar el ZIP
                progressDiv.textContent = 'Generando archivo ZIP...';
                const zipBlob = await zip.generateAsync({type: 'blob'});
                
                // Crear URL y descargar
                const zipUrl = URL.createObjectURL(zipBlob);
                const downloadLink = document.createElement('a');
                downloadLink.href = zipUrl;
                downloadLink.download = 'documentos_firmados.zip';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(zipUrl);
                
                // Eliminar indicador de progreso
                document.body.removeChild(progressDiv);
                
                alert('Todos los documentos han sido firmados y descargados.');
            } catch (error) {
                console.error('Error al firmar todos los PDFs:', error);
                alert('Ocurri贸 un error al procesar los documentos. Por favor, intente nuevamente.');
            }
        }

        async function procesarYFirmarPDF(pdfBlob) {
            const arrayBuffer = await pdfBlob.arrayBuffer();
            const pdfDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            const posicionFirma = await determinarPosicionFirmaContrato(pdfDoc);
            
            // Crear nuevo PDF con la firma
            const doc = new jspdf.jsPDF({
                orientation: 'portrait',
                unit: 'pt'
            });

            // Copiar p谩ginas y a帽adir firma
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await page.render({
                    canvasContext: context,
                    viewport: viewport,
                    intent: 'print'
                }).promise;

                const imgData = canvas.toDataURL('image/jpeg', 1.0);

                if (i > 1) {
                    doc.addPage();
                }

                doc.addImage(imgData, 'JPEG', 0, 0, doc.internal.pageSize.width, doc.internal.pageSize.height);

                if (i === pdfDoc.numPages) {
                    // A帽adir firma en la 煤ltima p谩gina
                    const img = new Image();
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = window.firmaUrl;
                    });

                    // Obtener las coordenadas del QR y ajustarlas a la escala del PDF
                    const qrX = posicionFirma.x * (doc.internal.pageSize.width / (viewport.width / 2));
                    const qrY = posicionFirma.y * (doc.internal.pageSize.height / (viewport.height / 2));
                    const qrWidth = posicionFirma.width * (doc.internal.pageSize.width / (viewport.width / 2));
                    const qrHeight = posicionFirma.height * (doc.internal.pageSize.height / (viewport.height / 2));

                    // Ajustar la posici贸n vertical (subir la firma)
                    const offsetY = qrHeight * 0.15;

                    // Borrar el QR
                    doc.setFillColor(255, 255, 255);
                    doc.rect(qrX, qrY - offsetY, qrWidth, qrHeight, 'F');

                    // A帽adir la firma
                    doc.addImage(window.firmaUrl, 'PNG', qrX, qrY - offsetY, qrWidth, qrHeight);
                }
            }

            return doc.output('blob');
        }
    </script>
</body>
</html>
